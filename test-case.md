# OJIMON 結合・総合テスト　 バトルシステムについて

## 結合テスト

### テストケース

| Test Case ID | 機能カテゴリ                 | テストケース                           | 前提条件                                                                 | 手順                                                                                                      | 期待結果                                                                                                                |
|--------------|----------------------------|----------------------------------------|-------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| TC-01        | バトルロビー一覧表示機能     | 正常なバトルロビー一覧取得             | 有効な API エンドポイントにアクセス可能で、複数のバトルロビーデータが存在する | 1. バトルロビー一覧画面にアクセスする<br>2. API からロビー一覧データ（GET リクエスト）を取得する             | 画面上に各ロビーの主催者、バトルモード、参加枠、開始予定時刻などの基本情報がリスト表示される                              |
| TC-02        | バトルロビー一覧表示機能     | バトルロビーが存在しない場合の表示      | API からのレスポンスとしてロビーデータが空の場合                         | 1. バトルロビー一覧画面にアクセスする                                                                    | 「参加可能なロビーが存在しません」といった適切なメッセージが表示される                                                   |
| TC-03        | バトルロビー一覧表示機能     | API エラー発生時のエラーハンドリング    | ネットワーク障害や API 障害によりエラーが発生する                       | 1. バトルロビー一覧画面にアクセスする                                                                    | エラーメッセージが表示され、ユーザーに再試行や問い合わせを促す                                                          |
| TC-04        | バトルロビー詳細表示機能     | 正常なバトルロビー詳細の表示            | 有効なロビー ID が存在する                                              | 1. ロビー一覧から特定のロビーを選択する<br>2. ロビー詳細画面またはモーダルを開く                             | 選択したロビーの詳細情報（主催者、参加者一覧、バトルルール、開始予定時刻、備考等）が正しく表示される                     |
| TC-05        | バトルロビー詳細表示機能     | 存在しないロビー ID のエラーハンドリング | 無効なロビー ID を指定する状況                                          | 1. URL やルーティングパラメータを操作して存在しないロビー ID で詳細画面にアクセスする                      | 「ロビーが見つかりません」等のエラーメッセージが表示される                                                              |
| TC-06        | 新規バトルロビー作成機能     | 正常なロビー作成                        | ロビー作成フォームが正しく表示される                                   | 1. すべての必須項目（バトルモード、参加上限、開始予定時刻等）に正しい値を入力する<br>2. 作成ボタンをクリックする | 新規ロビーが正常に作成され、ロビー一覧に反映される。成功メッセージが表示される                                           |
| TC-07        | 新規バトルロビー作成機能     | 必須項目未入力時のバリデーションチェック | ロビー作成フォームが表示される                                         | 1. 必須項目のいずれかを空欄にして作成ボタンをクリックする                                                 | 対象の入力項目にエラーメッセージが表示され、ロビー作成処理が実行されない                                                |
| TC-08        | 新規バトルロビー作成機能     | 無効な開始時刻入力時のエラーチェック     | ロビー作成フォームが表示される                                         | 1. 開始時刻フィールドに無効な形式（例: abc）を入力する<br>2. 作成ボタンをクリックする                       | 開始時刻入力フィールドにエラーメッセージが表示され、ロビー作成が拒否される                                               |
| TC-09        | バトルロビー編集機能         | 正常なロビー編集                        | 既存のロビーが存在し、編集可能な状態である                              | 1. ロビー一覧または詳細画面から編集画面に遷移する<br>2. 必要な項目（開始予定時刻、バトルルール等）を変更する<br>3. 保存ボタンをクリックする | 変更が正常に反映され、更新後の内容がロビー詳細画面に正しく表示される                                                    |
| TC-10        | バトルロビー編集機能         | 編集時の無効な入力エラーチェック         | 既存のロビーが存在する                                                  | 1. 編集画面で無効な値（例: 無効な開始時刻形式）を入力する<br>2. 保存ボタンをクリックする                   | 対象フィールドにエラーメッセージが表示され、更新処理が中断される                                                         |
| TC-11        | バトルロビーキャンセル機能   | 正常なロビーキャンセル                  | 編集可能な既存のロビーが存在する                                        | 1. ロビー詳細画面でキャンセルボタンをクリックする<br>2. キャンセル確認ダイアログが表示された場合、確認操作を行う | 該当ロビーがキャンセルされ、ロビー一覧から削除される。キャンセル完了のメッセージが表示される                            |
| TC-12        | バトルロビーキャンセル機能   | 存在しないロビーのキャンセルエラー       | すでにキャンセル済み、または存在しないロビー                           | 1. 無効なロビー ID でキャンセル操作を試みる                                                              | 「ロビーが存在しません」または「既にキャンセルされています」のエラーメッセージが表示される                              |
| TC-13        | API 連携 / UI              | ローディングインジケーターの表示確認      | API 呼び出し中にローディングインジケーターが実装されている              | 1. ロビー一覧や詳細画面にアクセスし、API 呼び出し時を確認する                                             | API レスポンス待ちの間、ローディングインジケーターが表示される                                                          |
| TC-14        | API 連携 / UI              | API エラー発生時の UI フィードバック確認  | API 呼び出しでエラーが発生する状況をシミュレートする                    | 1. ロビー一覧または作成操作中に API エラーが発生する状況を再現する                                        | 適切なエラーメッセージが表示され、ユーザーに再試行または問い合わせの案内がされる                                       |

## 総合テスト

### テストケース

| Test Case ID | 機能カテゴリ / 観点                | テストケース                                        | 前提条件                                                                                                                                  | 手順                                                                                                                                                                                                                                            | 期待結果                                                                                                                                                                                                                                  |
|--------------|-----------------------------------|-----------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SYS-01       | クロスプラットフォーム同期         | iOS × PC ランクマッチ勝敗同期                        | ・iOS16 実機（PlayerA、rating 1200）<br>・PC Chrome（PlayerB、rating 1210）<br>・ステージング v1.3.0 へデプロイ済み                                                               | 1. PlayerA(iOS) と PlayerB(PC) がログインし「ランクマッチ開始」<br>2. Match-making API がペアリング<br>3. プリセット AI により 3 ターンで PlayerA 勝利<br>4. リザルト表示後、両端末で `/profile` API を取得                                      | a. 双方のリザルト UI が「PlayerA Win / PlayerB Lose」で一致<br>b. DB `battle_results` に winner_id=PlayerA, loser_id=PlayerB, turn_count=3 が登録<br>c. rating 変動 (+25 / ‑25) が `/profile` 応答に反映                                   |
| SYS-02       | 通信断復旧                         | バトル途中切断→30 秒以内再接続で復帰                 | ・バトルサーバ側でプレイヤ切断を 30 秒間キープする設定<br>・テスト用ネットワーク障害ツール（packet drop）                                                                      | 1. PlayerC(Android) がフリーマッチを開始<br>2. 2 ターン目で通信を切断 (Wi-Fi OFF)<br>3. 15 秒後に再接続 (Wi-Fi ON)<br>4. バトルを継続し 5 ターンで決着                                                                                             | a. 再接続時、ターン進行が正しく同期し巻き戻り / スキップなし<br>b. 切断から 30 秒以内は「待機中…」UI、それ以降は敗北扱いになることをログで確認<br>c. BattleLog に “RECONNECT_SUCCESS” が記録                                            |
| SYS-03       | 非機能 / 性能                      | ピーク同時 5 万対戦で p95 レイテンシ ≤ 400 ms        | ・K6 スクリプトで 5 万同時 WebSocket 接続負荷を生成<br>・APM ダッシュボード (Grafana) が参照可能                                                                               | 1. K6 を実行して対戦開始→3 ターンで終了の流れを継続 10 分間負荷<br>2. 実行中に APM で BattleAPI p95, CPU, メモリを監視                                                                                                                           | a. BattleAPI p95 レイテンシ ≤ 400 ms<br>b. エラー率 < 0.1 %<br>c. オートスケーラが想定通りに Pod を水平スケール（最小 10 → 最大 60）                                                             |
| SYS-04       | 再入場ガード / 一貫性             | 同一アカウント多重ログイン防止                       | ・PlayerD アカウントが存在し、スマホ + PC 同時利用可能                                                                                                                         | 1. スマホで PlayerD がバトルに参加<br>2. バトル継続中に PC ログインを試行<br>3. スマホ側を終了させず PC で再度バトルを開始                                                                                                                      | a. PC ログイン時に「既に別端末でバトル中です」の警告とログイン拒否<br>b. スマホ側のバトルが影響なく継続<br>c. 監査ログに `duplicate_login_blocked` イベント                                                         |
| SYS-05       | 外部連携 / Push 通知              | バトル結果 Push 通知の到達率                         | ・FCM / APNs キー設定済み<br>・バトル結果通知を ON にした 20 端末 (iOS10台, Android10台)                                                                                        | 1. 20 端末でユーザをログイン状態に<br>2. サーバでテストフラグを付けた CPU バトルを即時に 20 件実行し勝敗確定<br>3. Push キューをモニタ                                                                                | a. 20/20 端末に 60 秒以内で通知が届く到達率 100 %<br>b. 通知タップでリザルト画面が直接起動<br>c. 未到達がある場合、Retry キューに登録されることをログで確認                                              |
| SYS-06       | ロギング / 監査 / セキュリティ    | BattleLog 改ざん検知 & シグネチャ検証               | ・署名付き BattleLog を S3 に保存する設定<br>・改ざんシミュレータ (署名改竄スクリプト)                                                                                         | 1. 正常バトルを 1 件実行し BattleLog を取得<br>2. 改ざんスクリプタで勝敗を逆転させた JSON を S3 に PUT<br>3. サーバ側処理（定期検証ジョブ）を手動トリガ                                                     | a. ジョブが該当ファイルを検出し “INVALID_SIGNATURE” アラートを Slack に送信<br>b. 改ざんログが S3 `quarantine/` へ移動<br>c. CloudWatch メトリクス `tamper_detected` が +1 カウント                                |
